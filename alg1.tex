\begin{algorithm}[t]
  \caption{Finding unfulfilled \MustCall obligations in a method.
    \Cref{alg:helpers} defines helper functions.}
  \label{alg:consistency-checker}
  \begin{algorithmic}[1]
  \Procedure{FindMissedCalls}{$CFG$}
  \State \textit{// D maps each statement s to a set of dataflow facts reaching}
  \State \textit{// s.  Each fact is of the form $\langle P, e \rangle$, where P is a set of variables}
  \State \textit{// that must-alias e and e is an expression with a nonempty}
  \State \textit{// must-call obligation.}
  \State $D \gets \textsc{InitialObligations}(CFG)$ \label{li:call-initial-obs}
  \While{$D$ has not reached fixed point}
    \For{$s \in \mathit{CFG.statements}$, $\langle P, e \rangle \in D(s)$}
    \If{$s$ is $\mathit{exit}$} \label{li:end-scope}
      \State report a must-call violation for $e$
    \ElsIf{$\neg \textsc{MCSatisfiedAfter}(P,s)$} \label{li:check-satisfied}
%    \State // \textit{propagate to successors}
    \State $kill \gets $ $s$ assigns a variable ? $\{s.LHS\}$ : $\emptyset$ \label{li:compute-kill}
    \State $gen \gets \textsc{CreatesAlias}(P,s)$ ? $\{s.LHS\}$ : $\emptyset$ \label{li:compute-gen} 
    % \If{$s$ is \lstinline{p = q} and $q \in P$}
    % \State $gen \gets \{p\}$
    % \EndIf
    \State $N \gets (P - kill) \cup gen$ \label{li:compute-new-mc-aliases}
 %   \State // \textit{we even propagate }$\emptyset$\textit{; error reported at exit}
    \State $\forall t \in \mathit{CFG.succ}(s)\ .\ D(t) \leftarrow D(t) \cup \langle
    N, e \rangle$ \label{li:prop-to-succs}
    \EndIf
    \EndFor
  \EndWhile \label{li:alg-loop-end}
  \EndProcedure
  \Procedure{InitialObligations}{$CFG$}
  \State $D \gets \{ s \mapsto \emptyset\ |\ s \in \mathit{CFG.statements} \}$\label{li:start-init}
  \For{$p \in \mathit{CFG.formals}$, $t \in \mathit{CFG.succ}(\mathit{CFG.entry})$}\label{li:init-formals}
    \If{$\textsc{HasObligation}(p)$}
      \State $D(t) \gets D(t) \cup \lbrace \langle \{p\}, p \rangle \rbrace$
    \EndIf
  \EndFor \label{li:end-init-formals}
  \For{$s \in \mathit{CFG.statements}$ of the form \lstinline{p = m(p1, p2, ...)}} \label{li:init-calls}
    \State $\forall t \in \mathit{CFG.succ}(s)\ .\ D(t) \leftarrow D(t) \cup \textsc{FactsFromCall}(s)$
  \EndFor  \label{li:end-init}
  \State \Return $D$
  \EndProcedure
  \end{algorithmic}
\end{algorithm}
